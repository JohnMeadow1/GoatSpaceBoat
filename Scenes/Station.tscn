[gd_scene load_steps=37 format=2]

[ext_resource path="res://Nodes/Player.tscn" type="PackedScene" id=1]
[ext_resource path="res://Scripts/Station.gd" type="Script" id=2]
[ext_resource path="res://panels/TestPanel.tscn" type="PackedScene" id=3]
[ext_resource path="res://panels/CoveredPanel.tscn" type="PackedScene" id=4]
[ext_resource path="res://Nodes/PanelDisplay.tscn" type="PackedScene" id=5]
[ext_resource path="res://Nodes/Passage.tscn" type="PackedScene" id=6]
[ext_resource path="res://Models/Pregi.obj" type="ArrayMesh" id=7]
[ext_resource path="res://Models/Walls_and_floor.obj" type="ArrayMesh" id=8]
[ext_resource path="res://Sprites/Connecting.png" type="Texture" id=9]
[ext_resource path="res://panels/CablePanel.tscn" type="PackedScene" id=10]
[ext_resource path="res://Scenes/Station/Walls_and_floor.png" type="Texture" id=11]
[ext_resource path="res://Scenes/Station/Pregi.jpg" type="Texture" id=12]
[ext_resource path="res://panels/SymbolPanel.tscn" type="PackedScene" id=13]
[ext_resource path="res://Resources/infopanel_font.tres" type="DynamicFont" id=14]
[ext_resource path="res://panels/GeneralSprites/panel_base.png" type="Texture" id=15]
[ext_resource path="res://Resources/spaceranger.ttf" type="DynamicFontData" id=16]

[sub_resource type="SpatialMaterial" id=1]
albedo_texture = ExtResource( 11 )

[sub_resource type="SpatialMaterial" id=2]
albedo_texture = ExtResource( 12 )

[sub_resource type="GDScript" id=3]
script/source = "extends Sprite

onready var label := $MarginContainer/Label as Label

var displayed_info: bool

func panel_focus():
	if not displayed_info:
		displayed_info = true
		label.text = \"Hello R0-B07. You were activated due to spaceship malfunctions. Please move the Communication Cube to Control Panel to connect to Houston.\\nPress Escape to continue\"
		label.visible_characters = 0
		label.align = Label.ALIGN_FILL

func _process(delta: float) -> void:
	if label.percent_visible < 1:
		label.visible_characters += 1
"

[sub_resource type="GDScript" id=4]
script/source = "extends Sprite

const TEXT1 = \"Checking subsystems...\"
const TEXT2 = \"Problems found.\"
const TEXT3 = \"Connecting to Houston...\"
const TEXT4 = \"\\\"Houston we have a problem\\\" sent successfully.\"
const TEXT5 = \"Displaying list of problems. Consult Houston to fix them.\"

const PROBLEMS = [
	\"Oxygen - correct \\n Temperature - correct \\n !!! MONEY - DANGEROUS LEAK\",
	\"Main Engineer is gone. \\n !!! MONEY LEAK !!! \\n Reduce expenses\",
	\"Engine power too low \\n Course deviation 0,3%/h\",
	\"!!! HEAVY RADIATION !!! \\n Find the source\"
]

onready var label := $MarginContainer/Label as Label

var current_problem := -1
var resolved: bool setget set_resolved

func _on_ControlCube_connected() -> void:
	label.text = \"Cube inserted\"
	
	var seq := TweenSequence.new(get_tree())
	seq.append_interval(1)
	set_text(seq, TEXT1)
	loading(seq)
	set_text(seq, TEXT2)
	seq.append_interval(0.5)
	set_text(seq, TEXT3)
	seq.append_callback($AnimatedSprite, \"show\")
	loading(seq)
	seq.append_callback($AnimatedSprite, \"hide\")
	set_text(seq, TEXT4)
	seq.append_interval(1)
	set_text(seq, TEXT5)
	seq.append_interval(2)
	seq.append_callback(self, \"next_problem\")
	
func set_text(seq: TweenSequence, text: String):
	seq.append_callback(label, \"set_visible_characters\", [0])
	seq.append_callback(label, \"set_text\", [text])
	seq.append(label, \"percent_visible\", 1, 1)

func loading(seq: TweenSequence):
	seq.append_method(self, \"animate_text\", 0, 4, 0.5)
	seq.append_method(self, \"animate_text\", 0, 4, 0.5)
	seq.append_method(self, \"animate_text\", 0, 4, 0.5)
	seq.append_method(self, \"animate_text\", 0, 4, 0.5)
	seq.append_method(self, \"animate_text\", 0, 4, 0.5)

func animate_text(value: float):
	label.visible_characters = label.text.length() - 4 + int(value)

func next_problem():
	current_problem += 1
	var seq := TweenSequence.new(get_tree())
	set_text(seq, problem_text())
	seq.append_callback(self, \"set_resolved\", [false])

func problem_text():
	return str(\"Problem \", current_problem + 1, \" of \", PROBLEMS.size(), \"\\n\\n\", PROBLEMS[current_problem])

func set_resolved(r: bool):
	resolved = r
	if resolved:
		label.text = problem_text() + \"\\n\\nStatus: Resolved\"
	else:
		label.text = problem_text() + \"\\n\\nStatus: Unresolved\"

func panel_focus():
	if resolved:
		next_problem()
"

[sub_resource type="AtlasTexture" id=5]
flags = 4
atlas = ExtResource( 9 )
region = Rect2( 0, 0, 200, 200 )

[sub_resource type="AtlasTexture" id=6]
flags = 4
atlas = ExtResource( 9 )
region = Rect2( 200, 0, 200, 200 )

[sub_resource type="AtlasTexture" id=7]
flags = 4
atlas = ExtResource( 9 )
region = Rect2( 400, 0, 200, 200 )

[sub_resource type="AtlasTexture" id=8]
flags = 4
atlas = ExtResource( 9 )
region = Rect2( 600, 0, 200, 200 )

[sub_resource type="AtlasTexture" id=9]
flags = 4
atlas = ExtResource( 9 )
region = Rect2( 800, 0, 200, 200 )

[sub_resource type="SpriteFrames" id=10]
animations = [ {
"frames": [ SubResource( 5 ), SubResource( 6 ), SubResource( 7 ), SubResource( 8 ), SubResource( 9 ) ],
"loop": true,
"name": "default",
"speed": 10.0
} ]

[sub_resource type="GDScript" id=11]
script/source = "extends Carryable

func _physics_process(delta: float) -> void:
	rotate_y(PI * delta)

func on_carry():
	set_physics_process(false)
	can_carry = false
"

[sub_resource type="SpatialMaterial" id=12]
albedo_color = Color( 0.968627, 1, 0, 1 )
emission_enabled = true
emission = Color( 0.992157, 1, 0, 1 )
emission_energy = 0.5
emission_operator = 0
emission_on_uv2 = false

[sub_resource type="CubeMesh" id=13]
material = SubResource( 12 )
size = Vector3( 1, 1, 1 )

[sub_resource type="BoxShape" id=14]

[sub_resource type="GDScript" id=15]
script/source = "extends StaticBody

signal connected()

func _input_event(camera: Object, event: InputEvent, click_position: Vector3, click_normal: Vector3, shape_idx: int) -> void:
	if event is InputEventMouseButton:
		var carry: Spatial = Singleton.player_node.carried
		if event.pressed and carry:
			Singleton.player_node.remove_carry()
			$TargetPivot.add_child(carry)
			emit_signal(\"connected\")
"

[sub_resource type="SpatialMaterial" id=16]
albedo_color = Color( 1, 0, 0, 1 )

[sub_resource type="CubeMesh" id=17]
material = SubResource( 16 )

[sub_resource type="ConvexPolygonShape" id=18]
points = PoolVector3Array( -1, -1, -1, -1, -1, 1, -1, 1, -1, -1, 1, 1, 1, -1, -1, 1, -1, 1, 1, 1, -1, 1, 1, 1 )

[sub_resource type="DynamicFont" id=19]
size = 100
font_data = ExtResource( 16 )

[sub_resource type="GIProbeData" id=20]
bounds = AABB( -100, -100, -100, 200, 200, 200 )
cell_size = 1.5625
to_cell_xform = Transform( 0.64, 0, 0, 0, 0.64, 0, 0, 0, 0.64, 64, 64, 64 )
dynamic_data = PoolIntArray( 0, 8, 128, 128, 128, 8, 1, 2, 66, 2, 67, 66, 2, 3, 67, 3, -1, -1, -1, -1, 1, -1, -1, -1, 0, 0, 8355711, 0, -1, 2, -1, -1, -1, -1, -1, -1, 0, 0, 8355711, 65536, -1, -1, 3, -1, -1, -1, -1, -1, 0, 0, 8355711, 131073, -1, -1, -1, -1, -1, 4, -1, -1, 0, 0, 8355711, 196623, -1, 5, -1, -1, -1, -1, -1, -1, 0, 0, 8355711, 262271, -1, -1, -1, 6, -1, -1, -1, -1, 0, 0, 8355711, 328703, -1, -1, -1, -1, -1, 7, -1, -1, 0, 0, 8355711, 401407, -1, -1, -1, -1, -1, -1, -1, -1, 6441557, 0, 8021244, 524287 )
dynamic_range = 4
bias = 1.5
normal_bias = 0.0
propagation = 0.7

[node name="Station" type="Spatial"]
script = ExtResource( 2 )

[node name="Player" parent="." groups=[
"player",
] instance=ExtResource( 1 )]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, -75.8038, 19.8004 )

[node name="Camera" type="Camera" parent="."]
transform = Transform( 0.99963, 0.0095973, -0.02546, 0, 0.935726, 0.352727, 0.0272088, -0.352597, 0.93538, -0.902785, -65.246, 36.7471 )

[node name="StationPivot" type="Spatial" parent="."]

[node name="Station" type="MeshInstance" parent="StationPivot"]
transform = Transform( 1, 0, 0, 0, -1.62921e-07, -1, 0, 1, -1.62921e-07, 0, 0, 0 )
material_override = SubResource( 1 )
mesh = ExtResource( 8 )
material/0 = null
material/1 = null
material/2 = null
material/3 = null
material/4 = null
material/5 = null

[node name="Station2" type="MeshInstance" parent="StationPivot"]
transform = Transform( -4.37114e-08, -4.37114e-08, -1, -1, 1.91069e-15, 4.37114e-08, 0, 1, -4.37114e-08, 0, 0, -42.5 )
mesh = ExtResource( 8 )
material/0 = null
material/1 = null
material/2 = null
material/3 = null
material/4 = null
material/5 = null

[node name="Station3" type="MeshInstance" parent="StationPivot"]
transform = Transform( 1, 0, 0, 0, -1.62921e-07, -1, 0, 1, -1.62921e-07, 0, 0, -85 )
mesh = ExtResource( 8 )
material/0 = null
material/1 = null
material/2 = null
material/3 = null
material/4 = null
material/5 = null

[node name="Pregi" type="MeshInstance" parent="StationPivot"]
transform = Transform( 1, 0, 0, 0, -1.62921e-07, -1, 0, 1, -1.62921e-07, 0, 0, 0 )
material_override = SubResource( 2 )
mesh = ExtResource( 7 )
material/0 = null
material/1 = null
material/2 = null
material/3 = null
material/4 = null
material/5 = null
material/6 = null
material/7 = null
material/8 = null
material/9 = null
material/10 = null
material/11 = null
material/12 = null
material/13 = null
material/14 = null
material/15 = null
material/16 = null
material/17 = null
material/18 = null
material/19 = null
material/20 = null
material/21 = null

[node name="Intro" parent="StationPivot" instance=ExtResource( 5 )]
transform = Transform( 0.936164, 0.351564, 0, -0.351564, 0.936164, 0, 0, 0, 1, -25.2039, -63.9305, 5.19206 )

[node name="Panel" type="Sprite" parent="StationPivot/Intro"]
texture = ExtResource( 15 )
centered = false
script = SubResource( 3 )

[node name="MarginContainer" type="MarginContainer" parent="StationPivot/Intro/Panel"]
anchor_right = 1.0
anchor_bottom = 1.0
custom_constants/margin_right = 32
custom_constants/margin_top = 32
custom_constants/margin_left = 32
custom_constants/margin_bottom = 48
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Label" type="Label" parent="StationPivot/Intro/Panel/MarginContainer"]
margin_left = 32.0
margin_top = 32.0
margin_right = 1248.0
margin_bottom = 672.0
size_flags_vertical = 1
custom_fonts/font = ExtResource( 14 )
custom_colors/font_color = Color( 0.14902, 1, 0, 1 )
text = "Click me"
align = 1
valign = 1
autowrap = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="ReferenceRect" type="ReferenceRect" parent="StationPivot/Intro/Panel/MarginContainer"]
margin_left = 32.0
margin_top = 32.0
margin_right = 1248.0
margin_bottom = 672.0

[node name="ControlRoom" parent="StationPivot" instance=ExtResource( 5 )]
transform = Transform( 0.412596, 0.910914, 0, -0.910914, 0.412596, 0, 0, 0, 1, -61.1136, -25.3218, 5.19206 )

[node name="Panel" type="Sprite" parent="StationPivot/ControlRoom"]
texture = ExtResource( 15 )
centered = false
script = SubResource( 4 )

[node name="MarginContainer" type="MarginContainer" parent="StationPivot/ControlRoom/Panel"]
anchor_right = 1.0
anchor_bottom = 1.0
custom_constants/margin_right = 32
custom_constants/margin_top = 32
custom_constants/margin_left = 32
custom_constants/margin_bottom = 48
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Label" type="Label" parent="StationPivot/ControlRoom/Panel/MarginContainer"]
margin_left = 32.0
margin_top = 32.0
margin_right = 1248.0
margin_bottom = 672.0
size_flags_vertical = 1
custom_fonts/font = ExtResource( 14 )
custom_colors/font_color = Color( 0.14902, 1, 0, 1 )
text = "Please insert Connection Cube"
align = 1
valign = 1
autowrap = true
__meta__ = {
"_edit_use_anchors_": false
}

[node name="ReferenceRect" type="ReferenceRect" parent="StationPivot/ControlRoom/Panel/MarginContainer"]
margin_left = 32.0
margin_top = 32.0
margin_right = 1248.0
margin_bottom = 672.0

[node name="AnimatedSprite" type="AnimatedSprite" parent="StationPivot/ControlRoom/Panel"]
visible = false
position = Vector2( 619.647, 178.999 )
z_index = 2
frames = SubResource( 10 )
playing = true

[node name="PanelDisplay" parent="StationPivot" instance=ExtResource( 5 )]
transform = Transform( 0.97415, 0.225903, 0, -0.225903, 0.97415, 0, 0, 0, 1, 7.7097, -59.1625, 5.19206 )

[node name="SymbolPanel" parent="StationPivot/PanelDisplay" instance=ExtResource( 13 )]

[node name="PanelDisplay3" parent="StationPivot" instance=ExtResource( 5 )]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 27.6286, -67.178, 5.19206 )

[node name="CoveredPanel" parent="StationPivot/PanelDisplay3" instance=ExtResource( 4 )]
underpanel = ExtResource( 3 )

[node name="PanelDisplay2" parent="StationPivot" instance=ExtResource( 5 )]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 42.0728, -58.1683, 5.19206 )

[node name="CoveredPanel" parent="StationPivot/PanelDisplay2" instance=ExtResource( 4 )]
underpanel = ExtResource( 10 )

[node name="Passage" parent="StationPivot" instance=ExtResource( 6 )]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0.308463, -76.2884, 1.22882 )

[node name="Passage3" parent="StationPivot" instance=ExtResource( 6 )]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0.308463, 73.7361, 1.22882 )

[node name="Passage2" parent="StationPivot" instance=ExtResource( 6 )]
transform = Transform( -1.62921e-07, -1, 0, 1, -1.62921e-07, 0, 0, 0, 1, -75.9228, 1.6404, -39.6229 )

[node name="Passage4" parent="StationPivot" instance=ExtResource( 6 )]
transform = Transform( -1.62921e-07, -1, 0, 1, -1.62921e-07, 0, 0, 0, 1, 77.7107, 1.6404, -39.6229 )

[node name="ComCube" type="StaticBody" parent="StationPivot"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, -10.2416, -76.0216, 9.41644 )
script = SubResource( 11 )

[node name="MeshInstance" type="MeshInstance" parent="StationPivot/ComCube"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.5, 0 )
mesh = SubResource( 13 )
material/0 = null

[node name="CollisionShape" type="CollisionShape" parent="StationPivot/ComCube"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.5, 0 )
shape = SubResource( 14 )

[node name="OmniLight" type="OmniLight" parent="StationPivot/ComCube"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0.5, 0 )
light_color = Color( 1, 0.913725, 0, 1 )

[node name="ControlCube" type="StaticBody" parent="StationPivot"]
transform = Transform( 0.309863, 0.950781, 0, -0.950781, 0.309863, 0, 0, 0, 1, -70.0118, -29.3606, 7.61171 )
script = SubResource( 15 )

[node name="MeshInstance" type="MeshInstance" parent="StationPivot/ControlCube"]
mesh = SubResource( 17 )
material/0 = null

[node name="CollisionShape" type="CollisionShape" parent="StationPivot/ControlCube"]
shape = SubResource( 18 )

[node name="TargetPivot" type="Position3D" parent="StationPivot/ControlCube"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 2, 0 )

[node name="Signs" type="Spatial" parent="StationPivot"]

[node name="PanelDisplay" parent="StationPivot/Signs" instance=ExtResource( 5 )]
transform = Transform( 0.422618, 0.906308, 0, -0.906308, 0.422618, 0, 0, 0, 1, -56.1759, -22.6728, 5.21336 )

[node name="ColorRect" type="ColorRect" parent="StationPivot/Signs/PanelDisplay"]
anchor_right = 1.0
anchor_bottom = 1.0
rect_min_size = Vector2( 1024, 600 )
color = Color( 0.298039, 0.188235, 0.188235, 1 )
__meta__ = {
"_edit_use_anchors_": false
}

[node name="Label" type="Label" parent="StationPivot/Signs/PanelDisplay/ColorRect"]
anchor_right = 1.0
anchor_bottom = 1.0
custom_fonts/font = SubResource( 19 )
text = "Control Room"
align = 1
valign = 1
__meta__ = {
"_edit_use_anchors_": false
}

[node name="GIProbe" type="GIProbe" parent="."]
visible = false
extents = Vector3( 100, 100, 100 )
data = SubResource( 20 )
[connection signal="connected" from="StationPivot/ControlCube" to="StationPivot/ControlRoom/Panel" method="_on_ControlCube_connected"]
